{% extends 'master.html' %}

{% block head_css %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">
  <style>
    .analytics-card {
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 15px;
      background-color: white;
    }
    .metric-card {
      text-align: center;
    }
    .metric-value {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
    }
    .metric-trend {
      font-size: 14px;
    }
    .trend-up {
      color: #28a745;
    }
    .trend-down {
      color: #dc3545;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    .chart-container-sm {
      position: relative;
      height: 250px;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 15px;
    }
  </style>
{% endblock %}

{% block body %}
  <h1>Analytics</h1>
  
  <div class="row">
    <!-- Today's Summary -->
    <div class="col-md-3">
      <div class="analytics-card metric-card">
        <div class="text-muted">New Influencers Today</div>
        <div class="metric-value">{{ new_influencers_today }}</div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="analytics-card metric-card">
        <div class="text-muted">New Fans Today</div>
        <div class="metric-value">{{ new_fans_today }}</div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="analytics-card metric-card">
        <div class="text-muted">Chats Today</div>
        <div class="metric-value">{{ chats_today }}</div>
        <div class="metric-trend {% if chats_growth > 0 %}trend-up{% elif chats_growth < 0 %}trend-down{% endif %}">
          {% if chats_growth > 0 %}
            <i class="fa fa-arrow-up"></i> {{ "%.1f"|format(chats_growth) }}% vs. yesterday
          {% elif chats_growth < 0 %}
            <i class="fa fa-arrow-down"></i> {{ "%.1f"|format(chats_growth|abs) }}% vs. yesterday
          {% else %}
            No change vs. yesterday
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="analytics-card metric-card">
        <div class="text-muted">Product Recommendations Today</div>
        <div class="metric-value">{{ product_recs_today }}</div>
        {% if chats_today > 0 %}
        <div class="metric-trend">{{ "%.1f"|format(product_recs_today / chats_today * 100) }}% conversion rate</div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Monthly Trend Chart -->
    <div class="col-md-8">
      <div class="analytics-card">
        <div class="chart-title">30-Day Activity Trend</div>
        <div class="chart-container">
          <canvas id="monthlyTrendChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Active Users -->
    <div class="col-md-4">
      <div class="analytics-card">
        <div class="chart-title">Active Users (Last 7 Days)</div>
        <div class="chart-container-sm">
          <canvas id="activeUsersChart"></canvas>
        </div>
        <div class="text-center mt-2">
          <div><strong>{{ active_influencers }}</strong> active influencers</div>
          <div><strong>{{ active_fans }}</strong> active fans</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Platform Distribution -->
    <div class="col-md-6">
      <div class="analytics-card">
        <div class="chart-title">Affiliate Platform Distribution</div>
        <div class="chart-container-sm">
          <canvas id="platformChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Conversion Rate Analysis -->
    <div class="col-md-6">
      <div class="analytics-card">
        <div class="chart-title">Conversion Rate Analysis</div>
        <div class="chart-container-sm">
          <canvas id="conversionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block tail_js %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
  <script>
    // Monthly Trend Chart
    var trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
    var trendChart = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: {{ dates_json|safe }},
        datasets: [
          {
            label: 'Total Chats',
            data: {{ chat_counts_json|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            fill: true
          },
          {
            label: 'Product Recommendations',
            data: {{ product_counts_json|safe }},
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          xAxes: [{
            gridLines: {
              display: false
            },
            ticks: {
              maxTicksLimit: 10
            }
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true,
              precision: 0
            }
          }]
        },
        tooltips: {
          mode: 'index',
          intersect: false
        }
      }
    });
    
    // Active Users Chart
    var activeUsersCtx = document.getElementById('activeUsersChart').getContext('2d');
    var activeUsersChart = new Chart(activeUsersCtx, {
      type: 'doughnut',
      data: {
        labels: ['Active Influencers', 'Active Fans'],
        datasets: [{
          data: [{{ active_influencers }}, {{ active_fans }}],
          backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'bottom'
        }
      }
    });
    
    // Platform Distribution Chart
    var platformCtx = document.getElementById('platformChart').getContext('2d');
    var platformChart = new Chart(platformCtx, {
      type: 'pie',
      data: {
        labels: {{ platform_labels_json|safe }},
        datasets: [{
          data: {{ platform_values_json|safe }},
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'bottom'
        }
      }
    });
    
    // Conversion Rate Chart (example data - would need actual data for this)
    var conversionData = [];
    {% for i in range(0, dates_json|length) %}
      {% if chat_counts_json[i] > 0 and product_counts_json[i] > 0 %}
        conversionData.push(({{ product_counts_json[i] }} / {{ chat_counts_json[i] }}) * 100);
      {% else %}
        conversionData.push(0);
      {% endif %}
    {% endfor %}
    
    var conversionCtx = document.getElementById('conversionChart').getContext('2d');
    var conversionChart = new Chart(conversionCtx, {
      type: 'bar',
      data: {
        labels: {{ dates_json|safe }},
        datasets: [{
          label: 'Conversion Rate (%)',
          data: conversionData,
          backgroundColor: 'rgba(75, 192, 192, 0.8)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          xAxes: [{
            gridLines: {
              display: false
            },
            ticks: {
              maxTicksLimit: 10
            }
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true,
              callback: function(value) {
                return value + '%';
              }
            }
          }]
        },
        tooltips: {
          callbacks: {
            label: function(tooltipItem, data) {
              return tooltipItem.yLabel.toFixed(1) + '%';
            }
          }
        }
      }
    });
  </script>
{% endblock %}