{% extends 'master.html' %}

{% block head_css %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">
  <style>
    .dashboard-card {
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 15px;
    }
    .metric-card {
      text-align: center;
      background-color: white;
    }
    .metric-value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .metric-title {
      text-transform: uppercase;
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .chart-container {
      position: relative;
      height: 300px;
      background-color: white;
    }
    .table-card {
      background-color: white;
    }
    .recent-activity-table td {
      vertical-align: middle;
    }
  </style>
{% endblock %}

{% block body %}
  <h1>AvatarCommerce Dashboard</h1>
  
  <div class="row">
    <!-- Key Metrics -->
    <div class="col-md-3">
      <div class="dashboard-card metric-card">
        <div class="metric-title">Influencers</div>
        <div class="metric-value">{{ influencer_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-card metric-card">
        <div class="metric-title">Fans</div>
        <div class="metric-value">{{ fan_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-card metric-card">
        <div class="metric-title">Chat Interactions</div>
        <div class="metric-value">{{ chat_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="dashboard-card metric-card">
        <div class="metric-title">Product Recommendations</div>
        <div class="metric-value">{{ product_rec_count }}</div>
        <div class="text-muted">{{ "%.1f"|format(product_rec_rate) }}% of chats</div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Activity Chart -->
    <div class="col-md-8">
      <div class="dashboard-card">
        <h5>Chat Activity (Last 30 Days)</h5>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Top Influencers -->
    <div class="col-md-4">
      <div class="dashboard-card table-card">
        <h5>Top Influencers</h5>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Influencer</th>
              <th>Chat Count</th>
            </tr>
          </thead>
          <tbody>
            {% for influencer in top_influencers %}
            <tr>
              <td>{{ influencer.username }}</td>
              <td>{{ influencer.chat_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Recent Activity -->
  <div class="row">
    <div class="col-md-12">
      <div class="dashboard-card table-card">
        <h5>Recent Chat Activity</h5>
        <table class="table table-sm recent-activity-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Influencer</th>
              <th>Fan</th>
              <th>Message</th>
              <th>Product Rec</th>
            </tr>
          </thead>
          <tbody>
            {% for chat, influencer_name, fan_name in recent_chats %}
            <tr>
              <td>{{ chat.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ influencer_name }}</td>
              <td>{{ fan_name or 'Anonymous' }}</td>
              <td>{{ chat.user_message[:50] + '...' if chat.user_message|length > 50 else chat.user_message }}</td>
              <td>
                {% if chat.product_recommendations %}
                <span class="badge badge-success">Yes</span>
                {% else %}
                <span class="badge badge-secondary">No</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block tail_js %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
  <script>
    // Chart for Daily Chat Activity
    var ctx = document.getElementById('activityChart').getContext('2d');
    var activityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ dates_json|safe }},
        datasets: [{
          label: 'Chat Interactions',
          data: {{ counts_json|safe }},
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(54, 162, 235, 1)',
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          xAxes: [{
            gridLines: {
              display: false
            },
            ticks: {
              maxTicksLimit: 10
            }
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true,
              precision: 0
            }
          }]
        },
        tooltips: {
          mode: 'index',
          intersect: false
        },
        hover: {
          mode: 'nearest',
          intersect: true
        }
      }
    });
  </script>
{% endblock %}